<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>‚öôÔ∏è</text></svg>">
    <link rel="stylesheet" href="css/admin.css">
    <link rel="stylesheet" href="css/modal.css">
</head>

<body class="admin-page">
    <div id="toastContainer"></div>

    <div class="shortcuts-help" id="shortcutsHelp">
        <h3>? Ajuda e Suporte</h3>

        <h4>Atalhos de Teclado</h4>
        <ul>
            <li><kbd>Ctrl + S</kbd> - Salvar Altera√ß√µes</li>
            <li><kbd>Ctrl + Z</kbd> - Desfazer</li>
            <li><kbd>Ctrl + Shift + Z</kbd> - Refazer</li>
            <li><kbd>?</kbd> - Mostrar/Ocultar esta janela</li>
        </ul>

        <h4>Tutoriais</h4>
        <p>Em breve...</p>

        <h4>Contato para Suporte</h4>
        <p>gearlesm@gmail.com</p>
    </div>

    <div class="container">
        <div class="admin-panel">
            <div class="admin-header">
                <h1><span id="adminLogoIcon">‚öôÔ∏è</span> Painel Administrativo</h1>
                <div class="header-controls">
                    <div class="save-status" id="saveStatus">
                        <span id="saveText">Salvo</span>
                    </div>
                    <button class="help-btn" onclick="toggleHelp()" title="Atalhos de teclado">?</button>
                    <button class="help-btn" onclick="logout()" title="Sair">üö™</button>
                </div>
            </div>

            <div class="admin-content">
                <div class="section">
                    <h3>üìã Informa√ß√µes B√°sicas</h3>

                    <div class="form-group">
                        <label>Nome da Empresa *</label>
                        <input type="text" id="empresaNome" value="MinhaEmpresa" required>
                        <div class="error-msg">Campo obrigat√≥rio</div>
                    </div>

                    <hr style="margin-top: 20px; margin-bottom: 20px;">
                    <h5 style="margin-bottom: 1rem; color: #007bff;">Logo Principal (Cabe√ßalho do Site)</h5>
                    <small style="color: #6c757d; display: block; margin-bottom: 1rem;">Define o logo exibido no cabe√ßalho do seu site.</small>

                    <div class="form-group">
                        <label>Tipo de Logo</label>
                        <div class="logo-type-selector">
                            <button id="logoTypeTextBtn" class="btn-logo-type active"
                                onclick="setLogoType('text')">Texto</button>
                            <button id="logoTypeImageBtn" class="btn-logo-type"
                                onclick="setLogoType('image')">Imagem (Upload ou URL)</button>
                        </div>
                        <input type="hidden" id="logoType" value="text">
                    </div>

                    <div id="logoImageInputGroup" class="form-group hidden">
                        <label>Arquivo de Imagem do Logo</label>
                        <input type="file" id="logoUpload" accept="image/*"
                            onchange="handleImageUpload(event, 'logoImageUrl', '#logoPreview')">
                        <input type="hidden" id="logoImageUrl">
                        <div class="image-preview" id="logoPreview" style="max-width: 200px; height: 100px;"></div>
                    </div>
                    <hr style="margin-top: 30px; margin-bottom: 20px;">

                    <h5 style="margin-bottom: 1rem; color: #007bff;">Favicon (√çcone da Aba do Navegador)</h5>
                    <small style="color: #6c757d; display: block; margin-bottom: 1rem;">O √≠cone que aparece na aba. Recomendado: PNG ou SVG 32x32px.</small>

                    <div class="form-group">
                        <label>Logo Pequeno (Favicon)</label>
                        <div class="image-upload-wrapper">
                            <input type="url" id="faviconImageUrl" placeholder="URL ou fa√ßa upload do seu √≠cone">
                            <button class="btn btn-success"
                                onclick="document.getElementById('faviconUpload').click()">Upload</button>
                            <input type="file" id="faviconUpload" accept="image/png, image/svg+xml" class="hidden"
                                onchange="handleImageUpload(event, 'faviconImageUrl', '#faviconPreview')">
                        </div>
                        <div class="image-preview" id="faviconPreview" style="max-width: 50px; height: 50px; border: 1px solid #ccc; background-size: contain; background-repeat: no-repeat;"></div>
                        <small style="color: #6c757d; font-size: 0.75rem; margin-top: 0.5rem;">
                            URL para o √≠cone de alta qualidade (32x32px).
                        </small>
                    </div>
                    <div class="form-group">
                        <label>T√≠tulo do Banner *</label>
                        <input type="text" id="bannerTitulo" value="Transforme Seu Neg√≥cio" required>
                        <div class="error-msg">Campo obrigat√≥rio</div>
                    </div>
                    <div class="form-group">
                        <label>Subt√≠tulo do Banner</label>
                        <input type="text" id="bannerSubtitulo" value="Solu√ß√µes modernas para sua empresa crescer">
                    </div>
                    <div class="form-group">
                        <label>Imagem do Banner</label>
                        <div class="image-upload-wrapper">
                            <input type="url" id="bannerImagem"
                                value="https://images.unsplash.com/photo-1497366216548-37526070297c?w=1200">
                            <button class="btn btn-success"
                                onclick="document.getElementById('bannerUpload').click()">Upload</button>
                            <input type="file" id="bannerUpload" accept="image/*" class="hidden"
                                onchange="handleImageUpload(event, 'bannerImagem')">
                        </div>
                        <div class="error-msg">URL inv√°lida</div>
                    </div>
                </div>

                <div class="section">
                    <h3>‚öôÔ∏è Configura√ß√µes Globais</h3>
                    <div class="form-group">
                        <h4>üé® Cores do Site</h4>
                        <div class="color-grid">
                            <div class="form-group">
                                <label>Cor Prim√°ria</label>
                                <div class="color-input">
                                    <input type="color" id="corPrimaria" value="#007bff">
                                    <input type="text" value="#007bff" readonly>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Cor Secund√°ria</label>
                                <div class="color-input">
                                    <input type="color" id="corSecundaria" value="#28a745">
                                    <input type="text" value="#28a745" readonly>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <h4>‚úíÔ∏è Fontes</h4>
                        <label>URL da Fonte (Google Fonts)</label>
                        <input type="url" id="fontUrl"
                            placeholder="Ex: https://fonts.googleapis.com/css2?family=Roboto&display=swap">
                        <label>Nome da Fonte (CSS)</label>
                        <input type="text" id="fontFamily" placeholder="Ex: 'Roboto', sans-serif">
                    </div>
                    <div class="form-group">
                        <h4>üìà Rastreamento</h4>
                        <label>C√≥digo de Rastreamento (ex: Google Analytics)</label>
                        <textarea id="trackingCode" rows="5"
                            placeholder="Cole o seu script de rastreamento aqui..."></textarea>
                    </div>
                </div>

                <div class="section">
                    <h3>üì¶ M√≥dulos</h3>
                    <div class="toggle">
                        <span>Se√ß√£o Sobre</span>
                        <div class="switch active" data-module="sobre"></div>
                    </div>
                    <div class="toggle">
                        <span>Se√ß√£o Produtos</span>
                        <div class="switch active" data-module="produtos"></div>
                    </div>
                    <div class="toggle">
                        <span>Se√ß√£o Contato</span>
                        <div class="switch active" data-module="contato"></div>
                    </div>
                </div>

                <div class="section">
                    <h3>‚ÑπÔ∏è Sobre</h3>
                    <div class="form-group">
                        <label>Texto</label>
                        <textarea
                            id="sobreTexto">Somos uma empresa dedicada a oferecer as melhores solu√ß√µes para nossos clientes.</textarea>
                    </div>
                    <div class="form-group">
                        <label>Imagem da Se√ß√£o</label>
                        <div class="image-upload-wrapper">
                            <input type="url" id="sobreImagem"
                                value="https://images.unsplash.com/photo-1522071820081-009f0129c71c?w=800">
                            <button class="btn btn-success"
                                onclick="document.getElementById('sobreUpload').click()">Upload</button>
                            <input type="file" id="sobreUpload" accept="image/*" class="hidden"
                                onchange="handleImageUpload(event, 'sobreImagem')">
                        </div>
                        <div class="error-msg">URL inv√°lida</div>
                    </div>
                </div>

                <div class="section">
                    <h3>üõçÔ∏è Produtos</h3>
                    <div id="produtosList"></div>
                    <button class="btn btn-success" onclick="openProdutoModal()">+ Adicionar Produto</button>
                </div>

                <div id="produtoModal" class="modal">
                    <div class="modal-content">
                        <span class="close" onclick="closeProdutoModal()">√ó</span>
                        <h3 id="produtoModalTitle">Adicionar Produto</h3>
                        <input type="hidden" id="produtoId">
                        <div class="form-group">
                            <label>Nome do Produto</label>
                            <input type="text" id="produtoNome" required>
                        </div>
                        <div class="form-group">
                            <label>Pre√ßo</label>
                            <input type="text" id="produtoPreco" required>
                        </div>
                        <div class="form-group">
                            <label>Descri√ß√£o</label>
                            <textarea id="produtoDescricao" rows="3"></textarea>
                        </div>
                        <div class="form-group">
                            <label>Imagem do Produto</label>
                            <div class="image-upload-wrapper">
                                <input type="url" id="produtoImagem">
                                <button class="btn btn-success"
                                    onclick="document.getElementById('produtoImagemUpload').click()">Upload</button>
                                <input type="file" id="produtoImagemUpload" accept="image/*" class="hidden"
                                    onchange="handleImageUpload(event, 'produtoImagem')">
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>Foco da Imagem (Arrast√°vel)</label>
                            <div id="imageFocuserContainer" style="width: 100%; height: 200px; border: 1px solid #ddd; background-size: cover; background-repeat: no-repeat; position: relative; margin-bottom: 0.5rem; cursor: pointer;">
                                <div id="focusTarget" style="position: absolute; width: 24px; height: 24px; border-radius: 50%; background: #dc3545; border: 3px solid white; box-shadow: 0 0 5px rgba(0,0,0,0.5); top: 50%; left: 50%; transform: translate(-50%, -50%); cursor: grab; z-index: 100;"></div>
                            </div>
                            <input type="hidden" id="produtoFocoHidden" value="50% 50%">
                            <small style="color: #6c757d; font-size: 0.75rem; margin-top: 0.3rem;">
                                Arraste o ponto vermelho para definir o foco da imagem. Posi√ß√£o atual: <span id="focusPositionDisplay">50% 50%</span>
                            </small>
                        </div>
                        
                        <button class="btn btn-primary" onclick="saveProduto()">Salvar Produto</button>
                    </div>
                </div>

                <div class="section">
                    <h3>üìû Contato</h3>
                    <div class="form-group">
                        <label>Telefone 1</label>
                        <input type="tel" id="telefone" value="(11) 9999-9999">
                    </div>
                    <div class="form-group">
                        <label>Telefone 2 (Opcional)</label>
                        <input type="tel" id="telefone2" placeholder="(11) 8888-8888">
                    </div>
                    <div class="form-group">
                        <label>E-mail *</label>
                        <input type="email" id="email" value="contato@minhaempresa.com" required>
                        <div class="error-msg">E-mail inv√°lido</div>
                    </div>

                    <div class="form-group">
                        <label>Endere√ßo Completo</label>
                        <input type="text" id="endereco" value="Rua Exemplo, 123 - S√£o Paulo, SP"
                            placeholder="Rua, n√∫mero, bairro - Cidade, Estado">
                        <small style="color: #6c757d; font-size: 0.8rem;">
                            üí° Digite o endere√ßo e clique no mapa para definir a localiza√ß√£o exata
                        </small>
                    </div>

                    <div class="form-group">
                        <label>Mapa Interativo - Clique para definir a localiza√ß√£o</label>
                        <div id="mapPreview"
                            style="width: 100%; height: 350px; border: 2px solid #dee2e6; border-radius: 8px; margin-bottom: 1rem; position: relative;">
                            </div>
                        <div style="display: flex; gap: 0.5rem; align-items: center;">
                            <button type="button" class="btn btn-secondary" onclick="buscarEnderecoMapa()"
                                style="flex: 1;">
                                üîç Buscar Endere√ßo
                            </button>
                            <button type="button" class="btn btn-secondary" onclick="usarLocalizacaoAtual()"
                                style="flex: 1;">
                                üìç Minha Localiza√ß√£o
                            </button>
                        </div>
                        <small style="color: #6c757d; font-size: 0.75rem; margin-top: 0.5rem;">
                            Latitude: <span id="latitudeDisplay">0.0000</span> | Longitude: <span
                                id="longitudeDisplay">0.0000</span>
                        </small>
                    </div>

                    <input type="hidden" id="latitude" value="-23.5505">
                    <input type="hidden" id="longitude" value="-46.6333">

                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="mostrarMapa" checked>
                            Mostrar mapa no site p√∫blico
                        </label>
                    </div>
                </div>

                <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />

                <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
                <script
                    src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-geocoder/1.0.8/Control.Geocoder.js"></script>

                <script>
                    let mapAdmin = null;
                    let markerAdmin = null;
                    let latitudeAtual = -23.5505;
                    let longitudeAtual = -46.6333;

                    // Inicializar mapa quando a p√°gina carregar
                    document.addEventListener('DOMContentLoaded', function () {
                        setTimeout(inicializarMapaAdmin, 500);
                    });

                    // ===== INICIALIZAR MAPA =====
                    function inicializarMapaAdmin() {
                        const mapContainer = document.getElementById('mapPreview');
                        if (!mapContainer || mapAdmin) return;

                        console.log('üìç Inicializando mapa do admin...');

                        // Carregar coordenadas salvas
                        const latSalva = parseFloat(document.getElementById('latitude').value) || -23.5505;
                        const lonSalva = parseFloat(document.getElementById('longitude').value) || -46.6333;

                        latitudeAtual = latSalva;
                        longitudeAtual = lonSalva;

                        // Criar mapa
                        mapAdmin = L.map('mapPreview', {
                            center: [latitudeAtual, longitudeAtual],
                            zoom: 15,
                            scrollWheelZoom: true
                        });

                        // Adicionar camada de mapa
                        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                            attribution: '¬© OpenStreetMap contributors',
                            maxZoom: 19
                        }).addTo(mapAdmin);

                        // Adicionar marcador inicial
                        markerAdmin = L.marker([latitudeAtual, longitudeAtual], {
                            draggable: true,
                            title: 'Clique para arrastar ou no mapa para reposicionar'
                        }).addTo(mapAdmin);

                        // Listener: Marcador arrastado
                        markerAdmin.on('dragend', function () {
                            const pos = markerAdmin.getLatLng();
                            atualizarCoordenadas(pos.lat, pos.lng);
                        });

                        // Listener: Clique no mapa
                        mapAdmin.on('click', function (e) {
                            const latlng = e.latlng;
                            markerAdmin.setLatLng(latlng);
                            atualizarCoordenadas(latlng.lat, latlng.lng);
                        });

                        console.log('‚úÖ Mapa carregado com sucesso!');
                    }

                    // ===== ATUALIZAR COORDENADAS =====
                    function atualizarCoordenadas(lat, lng) {
                        latitudeAtual = lat;
                        longitudeAtual = lng;

                        // Salvar nos inputs ocultos
                        document.getElementById('latitude').value = lat.toFixed(4);
                        document.getElementById('longitude').value = lng.toFixed(4);

                        // Atualizar display
                        document.getElementById('latitudeDisplay').textContent = lat.toFixed(4);
                        document.getElementById('longitudeDisplay').textContent = lng.toFixed(4);

                        console.log(`üìç Coordenadas atualizadas: ${lat.toFixed(4)}, ${lng.toFixed(4)}`);

                        markAsUnsaved();
                        update();
                    }

                    // ===== BUSCAR ENDERE√áO =====
                    async function buscarEnderecoMapa() {
                        const endereco = document.getElementById('endereco').value.trim();

                        if (!endereco) {
                            showToast('Digite um endere√ßo primeiro', 'error');
                            return;
                        }

                        showToast('Buscando endere√ßo...', 'info');

                        try {
                            // Usar Nominatim (geocoding p√∫blico gratuito)
                            const response = await fetch(
                                `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(endereco)}&limit=1`
                            );

                            const dados = await response.json();

                            if (dados.length === 0) {
                                showToast('Endere√ßo n√£o encontrado', 'error');
                                return;
                            }

                            const resultado = dados[0];
                            const lat = parseFloat(resultado.lat);
                            const lon = parseFloat(resultado.lon);

                            // Atualizar mapa
                            mapAdmin.setView([lat, lon], 15);
                            markerAdmin.setLatLng([lat, lon]);
                            atualizarCoordenadas(lat, lon);

                            showToast(`Localiza√ß√£o encontrada: ${resultado.address}`, 'success');

                        } catch (error) {
                            console.error('Erro ao buscar endere√ßo:', error);
                            showToast('Erro ao buscar endere√ßo: ' + error.message, 'error');
                        }
                    }

                    // ===== USAR LOCALIZA√á√ÉO ATUAL DO NAVEGADOR =====
                    function usarLocalizacaoAtual() {
                        if (!navigator.geolocation) {
                            showToast('Geolocaliza√ß√£o n√£o suportada pelo navegador', 'error');
                            return;
                        }

                        showToast('Obtendo sua localiza√ß√£o...', 'info');

                        navigator.geolocation.getCurrentPosition(
                            function (position) {
                                const lat = position.coords.latitude;
                                const lng = position.coords.longitude;

                                mapAdmin.setView([lat, lng], 15);
                                markerAdmin.setLatLng([lat, lng]);
                                atualizarCoordenadas(lat, lng);

                                showToast('Localiza√ß√£o atualizada! ‚úÖ', 'success');
                            },
                            function (error) {
                                console.error('Erro ao obter localiza√ß√£o:', error);
                                showToast('Erro ao obter localiza√ß√£o: ' + error.message, 'error');
                            }
                        );
                    }

                    // ===== BUSCAR ENDERE√áO AO DIGITAR (com delay) =====
                    let timeoutBusca;
                    document.addEventListener('DOMContentLoaded', function () {
                        const inputEndereco = document.getElementById('endereco');
                        if (inputEndereco) {
                            inputEndereco.addEventListener('change', function () {
                                clearTimeout(timeoutBusca);
                                timeoutBusca = setTimeout(() => {
                                    buscarEnderecoMapa();
                                }, 1000);
                            });
                        }
                    });
                </script>

                <!-- Scripts do Firebase -->
                <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
                <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
                <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
                <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>

                <!-- Configura√ß√£o do Firebase -->
                <script src="js/firebase-config.local.js"></script>

                <!-- Scripts da aplica√ß√£o -->
                <script src="js/toast.js"></script>
                <script src="js/validation.js"></script>
                <script src="js/app.js"></script>

                <div class="section">
                    <h3>üíæ Salvar Dados</h3>
                    <button class="btn btn-primary" onclick="saveConfig()">üíæ Salvar no Site</button>
                </div>
            </div>
        </div>

        <div class="preview">
            <iframe id="preview-iframe" src="index.html" style="width: 100%; height: 100%; border: none;"></iframe>
        </div>
    </div>

    <script>
        const previewIframe = document.getElementById('preview-iframe');
        previewIframe.onload = function() {
            const iframeDoc = previewIframe.contentDocument || previewIframe.contentWindow.document;
            const adminButton = iframeDoc.querySelector('.admin-login-icon');
            if (adminButton) {
                adminButton.style.display = 'none';
            }
        };
    </script>

    <script>
        // C√≥digo para carregar produtos na pr√©-visualiza√ß√£o
        function carregarProdutosPreview() {
            const produtosLista = document.getElementById('produtosListaPreview');
            produtosLista.innerHTML = ''; // Limpar lista existente

            // Obter produtos do Firestore
            db.collection('produtos').get().then((querySnapshot) => {
                querySnapshot.forEach((doc) => {
                    const produto = doc.data();
                    const produtoId = doc.id;

                    // Criar elemento do produto
                    const produtoElem = document.createElement('div');
                    produtoElem.classList.add('produto-item');
                    produtoElem.setAttribute('data-id', produtoId);
                    produtoElem.innerHTML = `
                        <h3>${produto.nome}</h3>
                        <p>Pre√ßo: R$ ${produto.preco.toFixed(2)}</p>
                        <img src="${produto.imagem}" alt="${produto.nome}" style="max-width: 100%; height: auto;">
                    `;

                    // Adicionar evento de clique para abrir o produto
                    produtoElem.addEventListener('click', () => {
                        abrirProdutoPreview(produtoId);
                    });

                    // Adicionar √† lista
                    produtosLista.appendChild(produtoElem);
                });
            });
        }

        // Chamar ao carregar a p√°gina
        document.addEventListener('DOMContentLoaded', () => {
            carregarProdutosPreview();
        });
    </script>
</body>
</html>