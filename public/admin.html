<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>‚öôÔ∏è</text></svg>">
    <link rel="stylesheet" href="css/admin.css">
    <link rel="stylesheet" href="css/modal.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
</head>

<body class="admin-page">
    <div id="toastContainer"></div>

    <div class="shortcuts-help" id="shortcutsHelp">
        <h3>? Ajuda e Suporte</h3>

        <h4>Atalhos de Teclado</h4>
        <ul>
            <li><kbd>Ctrl + S</kbd> - Salvar Altera√ß√µes</li>
            <li><kbd>Ctrl + Z</kbd> - Desfazer</li>
            <li><kbd>Ctrl + Shift + Z</kbd> - Refazer</li>
            <li><kbd>?</kbd> - Mostrar/Ocultar esta janela</li>
        </ul>

        <h4>Tutoriais</h4>
        <p>Em breve...</p>

        <h4>Contato para Suporte</h4>
        <p>gearlesm@gmail.com</p>
    </div>

    <div class="container">
        <div class="admin-panel">
            <div class="admin-header">
                <h1><span id="adminLogoIcon">‚öôÔ∏è</span> Painel Administrativo</h1>
                <div class="header-controls">
                    <div class="save-status" id="saveStatus">
                        <span id="saveText">Salvo</span>
                    </div>
                    <button class="help-btn" onclick="toggleHelp()" title="Atalhos de teclado">?</button>
                    <button class="help-btn" onclick="logout()" title="Sair">üö™</button>
                </div>
            </div>

            <div class="admin-content">
                <div class="section">
                    <h3>üìã Informa√ß√µes B√°sicas</h3>

                    <div class="form-group">
                        <label for="empresaNome">Nome da Empresa *</label>
                        <input type="text" id="empresaNome" value="MinhaEmpresa" required>
                        <div class="error-msg">Campo obrigat√≥rio</div>
                    </div>

                    <hr class="hr-divider">
                    <h5 class="section-subtitle">Logo Principal (Cabe√ßalho do Site)</h5>
                    <small class="subtitle-description">Define o logo exibido no cabe√ßalho do seu site.</small>

                    <div class="form-group">
                        <label>Tipo de Logo</label>
                        <div class="logo-type-selector">
                            <button id="logoTypeTextBtn" class="btn-logo-type active"
                                onclick="setLogoType('text')">Texto</button>
                            <button id="logoTypeImageBtn" class="btn-logo-type"
                                onclick="setLogoType('image')">Imagem (Upload ou URL)</button>
                        </div>
                        <input type="hidden" id="logoType" value="text">
                    </div>

                    <div id="logoImageInputGroup" class="form-group hidden">
                        <label for="logoUpload">Arquivo de Imagem do Logo</label>
                        <input type="file" id="logoUpload" accept="image/*"
                            onchange="handleImageUpload(event, 'logoImageUrl', '#logoPreview')" aria-label="Arquivo de Imagem do Logo">
                        <input type="hidden" id="logoImageUrl">
                        <div class="image-preview image-preview-logo" id="logoPreview"></div>
                    </div>
                    <hr class="hr-divider-lg">

                    <h5 class="section-subtitle">Favicon (√çcone da Aba do Navegador)</h5>
                    <small class="subtitle-description">O √≠cone que aparece na aba. Recomendado: PNG ou SVG 32x32px.</small>

                    <div class="form-group">
                        <label for="faviconImageUrl">Logo Pequeno (Favicon)</label>
                        <div class="image-upload-wrapper">
                            <input type="url" id="faviconImageUrl" placeholder="URL ou fa√ßa upload do seu √≠cone">
                            <button class="btn btn-success"
                                onclick="document.getElementById('faviconUpload').click()">Upload</button>
                            <input type="file" id="faviconUpload" accept="image/png, image/svg+xml" class="hidden"
                                onchange="handleImageUpload(event, 'faviconImageUrl', '#faviconPreview')" aria-label="Logo Pequeno (Favicon)">
                        </div>
                        <div class="image-preview image-preview-favicon" id="faviconPreview"></div>
                        <small class="small-text">
                            URL para o √≠cone de alta qualidade (32x32px).
                        </small>
                    </div>
                    <div class="form-group">
                        <label for="bannerTitulo">T√≠tulo do Banner *</label>
                        <input type="text" id="bannerTitulo" value="Transforme Seu Neg√≥cio" required>
                        <div class="error-msg">Campo obrigat√≥rio</div>
                    </div>
                    <div class="form-group">
                        <label for="bannerSubtitulo">Subt√≠tulo do Banner</label>
                        <input type="text" id="bannerSubtitulo" value="Solu√ß√µes modernas para sua empresa crescer">
                    </div>
                    <div class="form-group">
                        <label for="bannerImagem">Imagem do Banner</label>
                        <div class="image-upload-wrapper">
                            <input type="url" id="bannerImagem"
                                value="https://images.unsplash.com/photo-1497366216548-37526070297c?w=1200">
                            <button class="btn btn-success"
                                onclick="document.getElementById('bannerUpload').click()">Upload</button>
                            <input type="file" id="bannerUpload" accept="image/*" class="hidden"
                                onchange="handleImageUpload(event, 'bannerImagem')" aria-label="Imagem do Banner">
                        </div>
                        <div class="error-msg">URL inv√°lida</div>
                    </div>
                </div>

                <div class="section">
                    <h3>‚öôÔ∏è Configura√ß√µes Globais</h3>
                    <div class="form-group">
                        <h4>üé® Cores do Site</h4>
                        <div class="color-grid">
                            <div class="form-group">
                                <label for="corPrimaria">Cor Prim√°ria</label>
                                <div class="color-input">
                                    <input type="color" id="corPrimaria" value="#007bff" title="Cor Prim√°ria">
                                    <input type="text" value="#007bff" readonly aria-label="Valor hexadecimal da cor prim√°ria">
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="corSecundaria">Cor Secund√°ria</label>
                                <div class="color-input">
                                    <input type="color" id="corSecundaria" value="#28a745" title="Cor Secund√°ria">
                                    <input type="text" value="#28a745" readonly aria-label="Valor hexadecimal da cor secund√°ria">
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <h4>‚úíÔ∏è Fontes</h4>
                        <label for="fontUrl">URL da Fonte (Google Fonts)</label>
                        <input type="url" id="fontUrl"
                            placeholder="Ex: https://fonts.googleapis.com/css2?family=Roboto&display=swap">
                        <label for="fontFamily">Nome da Fonte (CSS)</label>
                        <input type="text" id="fontFamily" placeholder="Ex: 'Roboto', sans-serif">
                    </div>
                    <div class="form-group">
                        <h4>üìà Rastreamento</h4>
                        <label for="trackingCode">C√≥digo de Rastreamento (ex: Google Analytics)</label>
                        <textarea id="trackingCode" rows="5"
                            placeholder="Cole o seu script de rastreamento aqui..."></textarea>
                    </div>
                </div>

                <div class="section">
                    <h3>üì¶ M√≥dulos</h3>
                    <div class="toggle">
                        <span>Se√ß√£o Sobre</span>
                        <div class="switch active" data-module="sobre"></div>
                    </div>
                    <div class="toggle">
                        <span>Se√ß√£o Produtos</span>
                        <div class="switch active" data-module="produtos"></div>
                    </div>
                    <div class="toggle">
                        <span>Se√ß√£o Contato</span>
                        <div class="switch active" data-module="contato"></div>
                    </div>
                </div>

                <div class="section">
                    <h3>‚ÑπÔ∏è Sobre</h3>
                    <div class="form-group">
                        <label for="sobreTexto">Texto</label>
                        <textarea
                            id="sobreTexto">Somos uma empresa dedicada a oferecer as melhores solu√ß√µes para nossos clientes.</textarea>
                    </div>
                    <div class="form-group">
                        <label for="sobreImagem">Imagem da Se√ß√£o</label>
                        <div class="image-upload-wrapper">
                            <input type="url" id="sobreImagem"
                                value="https://images.unsplash.com/photo-1522071820081-009f0129c71c?w=800">
                            <button class="btn btn-success"
                                onclick="document.getElementById('sobreUpload').click()">Upload</button>
                            <input type="file" id="sobreUpload" accept="image/*" class="hidden"
                                onchange="handleImageUpload(event, 'sobreImagem')" aria-label="Imagem da Se√ß√£o">
                        </div>
                        <div class="error-msg">URL inv√°lida</div>
                    </div>
                </div>

                <div class="section">
                    <h3>üõçÔ∏è Produtos</h3>
                    <div id="produtosList"></div>
                    <button class="btn btn-success" onclick="openProdutoModal()">+ Adicionar Produto</button>
                </div>

                <div id="produtoModal" class="modal">
                    <div class="modal-content">
                        <span class="close" onclick="closeProdutoModal()">√ó</span>
                        <h3 id="produtoModalTitle">Adicionar Produto</h3>
                        <input type="hidden" id="produtoId">
                        <div class="form-group">
                            <label for="produtoNome">Nome do Produto</label>
                            <input type="text" id="produtoNome" required>
                        </div>
                        <div class="form-group">
                            <label for="produtoPreco">Pre√ßo</label>
                            <input type="text" id="produtoPreco" required>
                        </div>
                        <div class="form-group">
                            <label for="produtoDescricao">Descri√ß√£o</label>
                            <textarea id="produtoDescricao" rows="3"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="produtoImagem">Imagem do Produto</label>
                            <div class="image-upload-wrapper">
                                <input type="url" id="produtoImagem">
                                <button class="btn btn-success"
                                    onclick="document.getElementById('produtoImagemUpload').click()">Upload</button>
                                <input type="file" id="produtoImagemUpload" accept="image/*" class="hidden"
                                    onchange="handleImageUpload(event, 'produtoImagem')" aria-label="Imagem do Produto">
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="produtoFocoHidden">Foco da Imagem (Arrast√°vel)</label>
                            <div id="imageFocuserContainer" class="image-focuser-container">
                                <div id="focusTarget" class="focus-target"></div>
                            </div>
                            <input type="hidden" id="produtoFocoHidden" value="50% 50%">
                            <small class="small-text">
                                Arraste o ponto vermelho para definir o foco da imagem. Posi√ß√£o atual: <span id="focusPositionDisplay">50% 50%</span>
                            </small>
                        </div>
                        
                        <button class="btn btn-primary" onclick="saveProduto()">Salvar Produto</button>
                    </div>
                </div>

                <div class="section">
                    <h3>üìû Contato</h3>
                    <div class="form-group">
                        <label for="telefone">Telefone 1</label>
                        <input type="tel" id="telefone" value="(11) 9999-9999">
                    </div>
                    <div class="form-group">
                        <label for="telefone2">Telefone 2 (Opcional)</label>
                        <input type="tel" id="telefone2" placeholder="(11) 8888-8888">
                    </div>
                    <div class="form-group">
                        <label for="email">E-mail *</label>
                        <input type="email" id="email" value="contato@minhaempresa.com" required>
                        <div class="error-msg">E-mail inv√°lido</div>
                    </div>

                    <div class="form-group">
                        <label for="endereco">Endere√ßo Completo</label>
                        <input type="text" id="endereco" value="Rua Exemplo, 123 - S√£o Paulo, SP"
                            placeholder="Rua, n√∫mero, bairro - Cidade, Estado">
                        <small class="small-text-map">
                            üí° Digite o endere√ßo e clique no mapa para definir a localiza√ß√£o exata
                        </small>
                    </div>

                    <div class="form-group">
                        <label>Mapa Interativo - Clique para definir a localiza√ß√£o</label>
                        <div id="mapPreview"></div>
                        <div class="map-buttons">
                            <button type="button" class="btn btn-secondary" onclick="buscarEnderecoMapa()">
                                üîç Buscar Endere√ßo
                            </button>
                            <button type="button" class="btn btn-secondary" onclick="usarLocalizacaoAtual()">
                                üìç Minha Localiza√ß√£o
                            </button>
                        </div>
                        <small class="small-text">
                            Latitude: <span id="latitudeDisplay">0.0000</span> | Longitude: <span
                                id="longitudeDisplay">0.0000</span>
                        </small>
                    </div>

                    <input type="hidden" id="latitude" value="-23.5505">
                    <input type="hidden" id="longitude" value="-46.6333">

                    <div class="form-group">
                        <label for="mostrarMapa">
                            <input type="checkbox" id="mostrarMapa" checked>
                            Mostrar mapa no site p√∫blico
                        </label>
                    </div>
                </div>

                <div class="section">
                    <h3>üì± Redes Sociais</h3>
                    <div class="social-empty-state" id="socialEmptyState">
                        <div class="social-empty-state-icon">üì±</div>
                        <p>Nenhuma rede social adicionada ainda</p>
                    </div>
                    <div id="socialLinksList" class="social-links-list">
                        <!-- Lista de redes sociais ser√° renderizada aqui -->
                    </div>
                    <button class="btn btn-success" id="addSocialLinkBtn" onclick="openSocialModal()">+ Adicionar Rede Social</button>
                </div>

                <!-- Modal de Redes Sociais -->
                <div id="socialModal" class="social-modal">
                    <div class="social-modal-content">
                        <div class="social-modal-header">
                            <h3 id="socialModalTitle">Adicionar Rede Social</h3>
                            <button class="social-close" onclick="closeSocialModal()">&times;</button>
                        </div>

                        <div class="social-tabs">
                            <button class="social-tab-btn active" data-tab="predefined">Redes Populares</button>
                            <button class="social-tab-btn" data-tab="custom">Personalizado</button>
                        </div>

                        <div class="social-tab-content active" id="predefinedTab">
                            <div class="social-network-grid">
                                <!-- Redes Sociais Predefinidas -->
                                <div class="social-network-option" data-network="instagram">
                                    <i class="fab fa-instagram social-network-icon"></i>
                                    <div class="social-network-name">Instagram</div>
                                </div>
                                <div class="social-network-option" data-network="facebook">
                                    <i class="fab fa-facebook social-network-icon"></i>
                                    <div class="social-network-name">Facebook</div>
                                </div>
                                <div class="social-network-option" data-network="twitter">
                                    <i class="fab fa-twitter social-network-icon"></i>
                                    <div class="social-network-name">Twitter</div>
                                </div>
                                <div class="social-network-option" data-network="linkedin">
                                    <i class="fab fa-linkedin social-network-icon"></i>
                                    <div class="social-network-name">LinkedIn</div>
                                </div>
                                <div class="social-network-option" data-network="youtube">
                                    <i class="fab fa-youtube social-network-icon"></i>
                                    <div class="social-network-name">YouTube</div>
                                </div>
                                <div class="social-network-option" data-network="whatsapp">
                                    <i class="fab fa-whatsapp social-network-icon"></i>
                                    <div class="social-network-name">WhatsApp</div>
                                </div>
                                <div class="social-network-option" data-network="telegram">
                                    <i class="fab fa-telegram social-network-icon"></i>
                                    <div class="social-network-name">Telegram</div>
                                </div>
                                <div class="social-network-option" data-network="pinterest">
                                    <i class="fab fa-pinterest social-network-icon"></i>
                                    <div class="social-network-name">Pinterest</div>
                                </div>
                                <div class="social-network-option" data-network="tiktok">
                                    <i class="fab fa-tiktok social-network-icon"></i>
                                    <div class="social-network-name">TikTok</div>
                                </div>
                            </div>
                        </div>

                        <div class="social-tab-content" id="customTab">
                            <div class="form-group">
                                <label for="customIcon">√çcone Personalizado</label>
                                <input type="text" id="customIcon" class="social-custom-icon-input" maxlength="2" placeholder="üì±">
                                <small class="small-text">Digite um emoji ou s√≠mbolo para usar como √≠cone</small>
                            </div>
                            <div class="social-icon-preview-box" id="customIconPreview">
                                üì±
                            </div>
                        </div>

                        <div class="social-common-info">
                            <div class="form-group">
                                <label for="socialName">Nome da Rede Social *</label>
                                <input type="text" id="socialName" required>
                            </div>
                            <div class="form-group">
                                <label for="socialUrl">URL do Perfil *</label>
                                <input type="url" id="socialUrl" required placeholder="https://">
                            </div>
                        </div>

                        <div class="social-modal-actions">
                            <button class="btn btn-social-cancel" onclick="closeSocialModal()">Cancelar</button>
                            <button class="btn btn-social-save" onclick="saveSocialLink()">Salvar</button>
                        </div>
                    </div>
                </div>

                <!-- Font Awesome para √≠cones de redes sociais -->
                <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">

                <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />

                <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
                <script
                    src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-geocoder/1.0.8/Control.Geocoder.js"></script>

                <script>
                    let mapAdmin = null;
                    let markerAdmin = null;
                    let latitudeAtual = -23.5505;
                    let longitudeAtual = -46.6333;

                    // Inicializar mapa quando a p√°gina carregar
                    document.addEventListener('DOMContentLoaded', function () {
                        setTimeout(inicializarMapaAdmin, 500);
                    });

                    // ===== INICIALIZAR MAPA =====
                    function inicializarMapaAdmin() {
                        const mapContainer = document.getElementById('mapPreview');
                        if (!mapContainer || mapAdmin) return;

                        console.log('üìç Inicializando mapa do admin...');

                        // Carregar coordenadas salvas
                        const latSalva = parseFloat(document.getElementById('latitude').value) || -23.5505;
                        const lonSalva = parseFloat(document.getElementById('longitude').value) || -46.6333;

                        latitudeAtual = latSalva;
                        longitudeAtual = lonSalva;

                        // Criar mapa
                        mapAdmin = L.map('mapPreview', {
                            center: [latitudeAtual, longitudeAtual],
                            zoom: 15,
                            scrollWheelZoom: true
                        });

                        // Adicionar camada de mapa
                        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                            attribution: '¬© OpenStreetMap contributors',
                            maxZoom: 19
                        }).addTo(mapAdmin);

                        // Adicionar marcador inicial
                        markerAdmin = L.marker([latitudeAtual, longitudeAtual], {
                            draggable: true,
                            title: 'Clique para arrastar ou no mapa para reposicionar'
                        }).addTo(mapAdmin);

                        // Listener: Marcador arrastado
                        markerAdmin.on('dragend', function () {
                            const pos = markerAdmin.getLatLng();
                            atualizarCoordenadas(pos.lat, pos.lng);
                        });

                        // Listener: Clique no mapa
                        mapAdmin.on('click', function (e) {
                            const latlng = e.latlng;
                            markerAdmin.setLatLng(latlng);
                            atualizarCoordenadas(latlng.lat, latlng.lng);
                        });

                        console.log('‚úÖ Mapa carregado com sucesso!');
                    }

                    // ===== ATUALIZAR COORDENADAS =====
                    function atualizarCoordenadas(lat, lng) {
                        latitudeAtual = lat;
                        longitudeAtual = lng;

                        // Salvar nos inputs ocultos
                        document.getElementById('latitude').value = lat.toFixed(4);
                        document.getElementById('longitude').value = lng.toFixed(4);

                        // Atualizar display
                        document.getElementById('latitudeDisplay').textContent = lat.toFixed(4);
                        document.getElementById('longitudeDisplay').textContent = lng.toFixed(4);

                        console.log(`üìç Coordenadas atualizadas: ${lat.toFixed(4)}, ${lng.toFixed(4)}`);

                        markAsUnsaved();
                        update();
                    }



                    // ===== BUSCAR ENDERE√áO AO DIGITAR (com delay) =====
                    let timeoutBusca;
                    document.addEventListener('DOMContentLoaded', function () {
                        const inputEndereco = document.getElementById('endereco');
                        if (inputEndereco) {
                            inputEndereco.addEventListener('change', function () {
                                clearTimeout(timeoutBusca);
                                timeoutBusca = setTimeout(() => {
                                    buscarEnderecoMapa();
                                }, 1000);
                            });
                        }
                    });
                </script>

                <!-- Scripts do Firebase -->
                <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
                <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
                <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
                <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>

                <!-- Configura√ß√£o do Firebase -->
                <script src="js/firebase-config.local.js"></script>

                <!-- Inicializa√ß√£o do Firebase -->
                <script>
                    console.log('üî• [admin.html] Inicializando Firebase...');
                    if (typeof firebase !== 'undefined' && typeof firebaseConfig !== 'undefined') {
                        if (firebase.apps.length === 0) {
                            firebase.initializeApp(firebaseConfig);
                            console.log('‚úÖ [admin.html] Firebase inicializado com sucesso.');
                        } else {
                            console.log('üü° [admin.html] Firebase j√° estava inicializado.');
                        }
                    } else {
                        console.error('‚ùå [admin.html] Firebase SDK ou firebaseConfig n√£o encontrados.');
                    }
                </script>

                <!-- Auth Manager -->
                <script src="js/auth-manager.js"></script>

                <!-- Verifica√ß√£o de autentica√ß√£o com Auth Manager -->
                <script>
                    async function checkAccess() {
                        console.log('üîê [admin.html] Verificando acesso com Auth Manager...');
                        if (!window.authManager) {
                            console.error('‚ùå [admin.html] Auth Manager n√£o est√° dispon√≠vel.');
                            return;
                        }
                        await window.authManager.init(); // Garante que o listener est√° configurado
                        const user = await window.authManager.waitUntilReady(); // Espera o estado de auth ser resolvido

                        if (user) {
                            console.log('‚úÖ [admin.html] Usu√°rio autenticado:', user.email);
                            // O AuthManager j√° cuidou do redirecionamento se necess√°rio
                        } else {
                            console.log('‚ùå [admin.html] Usu√°rio n√£o autenticado. AuthManager deve redirecionar.');
                        }
                    }
                    checkAccess().catch(error => console.error('‚ùå [admin.html] Erro ao verificar acesso:', error));
                </script>

                <!-- Scripts da aplica√ß√£o -->
                <script src="js/toast.js"></script>
                <script src="js/validation.js"></script>
                <script src="js/app.js" type="module"></script>

                <div class="section">
                    <h3>üíæ Salvar Dados</h3>
                    <button class="btn btn-primary" onclick="saveConfig()">üíæ Salvar no Site</button>
                </div>
            </div>
        </div>

        <div class="preview">
            <iframe id="preview-iframe" src="index.html" class="preview-iframe" title="Pr√©-visualiza√ß√£o do Site"></iframe>
        </div>
    </div>

    <script>
        const previewIframe = document.getElementById('preview-iframe');
        previewIframe.onload = function() {
            const iframeDoc = previewIframe.contentDocument || previewIframe.contentWindow.document;
            const adminButton = iframeDoc.querySelector('.admin-login-icon');
            if (adminButton) {
                adminButton.style.display = 'none';
            }
        };
    </script>

    <script>
        // Sistema de Notifica√ß√µes Toast
        const toastSystem = {
            show: function(message, type = 'info') {
                const container = document.getElementById('toastContainer');
                if (!container) return;

                const toast = document.createElement('div');
                toast.className = `toast toast-${type}`;
                toast.textContent = message;

                container.appendChild(toast);

                setTimeout(() => {
                    toast.classList.add('show');
                }, 100);

                setTimeout(() => {
                    toast.classList.remove('show');
                    setTimeout(() => {
                        container.removeChild(toast);
                    }, 300);
                }, 3000);
            }
        };

        // Gerenciamento de Redes Sociais
        let selectedNetwork = null;
        if (typeof window.state === 'undefined') {
            window.state = {
                modules: { sobre: true, produtos: true, contato: true },
                produtos: [],
                socialLinks: []
            };
        }

        // Abrir Modal
        function openSocialModal() {
            document.getElementById('socialModal').style.display = 'block';
            document.getElementById('socialName').value = '';
            document.getElementById('socialUrl').value = '';
            document.getElementById('customIcon').value = '';
            document.querySelector('.social-common-info').classList.remove('show');
            
            // Resetar sele√ß√£o de rede social
            const options = document.querySelectorAll('.social-network-option');
            options.forEach(opt => opt.classList.remove('selected'));
            selectedNetwork = null;
        }

        // Fechar Modal
        function closeSocialModal() {
            document.getElementById('socialModal').style.display = 'none';
        }

        // Switch entre abas
        document.querySelectorAll('.social-tab-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                // Alternar bot√µes
                document.querySelectorAll('.social-tab-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                
                // Alternar conte√∫do
                document.querySelectorAll('.social-tab-content').forEach(content => content.classList.remove('active'));
                document.getElementById(this.dataset.tab + 'Tab').classList.add('active');

                // Mostrar/ocultar informa√ß√µes comuns
                if (this.dataset.tab === 'custom') {
                    document.querySelector('.social-common-info').classList.add('show');
                } else {
                    document.querySelector('.social-common-info').classList.remove('show');
                }
            });
        });

        // Selecionar rede social predefinida
        document.querySelectorAll('.social-network-option').forEach(option => {
            option.addEventListener('click', function() {
                document.querySelectorAll('.social-network-option').forEach(opt => opt.classList.remove('selected'));
                this.classList.add('selected');
                selectedNetwork = this.dataset.network;
                
                // Preencher nome e mostrar campos comuns
                document.getElementById('socialName').value = this.querySelector('.social-network-name').textContent;
                document.querySelector('.social-common-info').classList.add('show');
                document.getElementById('socialUrl').focus();
            });
        });

        // Preview do √≠cone personalizado
        document.getElementById('customIcon').addEventListener('input', function() {
            document.getElementById('customIconPreview').textContent = this.value || 'üì±';
        });

        // Salvar link social
        function saveSocialLink() {
            const name = document.getElementById('socialName').value.trim();
            const url = document.getElementById('socialUrl').value.trim();
            
            if (!name || !url) {
                toastSystem.show('‚ö†Ô∏è Preencha todos os campos obrigat√≥rios', 'warning');
                return;
            }

            if (!url.startsWith('http://') && !url.startsWith('https://')) {
                toastSystem.show('‚ö†Ô∏è URL inv√°lida. Use o formato completo (http:// ou https://)', 'warning');
                return;
            }

            let icon;
            if (selectedNetwork) {
                // Usar √≠cone da rede social predefinida
                icon = `<i class="fab fa-${selectedNetwork}"></i>`;
            } else {
                // Usar √≠cone personalizado
                icon = document.getElementById('customIcon').value || 'üì±';
            }

            const link = {
                id: Date.now(),
                name,
                url,
                icon
            };

            window.state.socialLinks.push(link);
            renderSocialLinks();
            closeSocialModal();
            if (typeof markAsUnsaved === 'function') markAsUnsaved();
            if (typeof update === 'function') update();
            
            // Atualiza o preview e salva no Firebase
            updatePreviewSocialLinks();

            // Salva imediatamente no Firebase
            const user = firebase.auth().currentUser;
            if (user && firebase.firestore) {
                const db = firebase.firestore();
                const socialLinksRef = db.collection('site').doc('cliente-001').collection('social_links').doc('data');
                socialLinksRef.set({ 
                    links: window.state.socialLinks 
                }, { merge: true })
                .then(() => {
                    toastSystem.show('‚úÖ Rede social adicionada e salva com sucesso!', 'success');
                })
                .catch(error => {
                    console.error('Erro ao salvar no Firebase:', error);
                    toastSystem.show('‚ö†Ô∏è Rede social adicionada, mas houve erro ao salvar no Firebase', 'warning');
                });
            }
        }

        // Renderizar lista de links sociais
        // Fun√ß√£o de sanitiza√ß√£o de HTML para uso local
        function sanitizeHtml(unsafe) {
            if (typeof unsafe !== 'string') return unsafe;
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        // Fun√ß√£o para atualizar links no preview do iframe
        function updatePreviewSocialLinks() {
            const previewIframe = document.getElementById('preview-iframe');
            if (previewIframe && previewIframe.contentWindow) {
                const previewDoc = previewIframe.contentWindow.document;
                const previewLinks = previewDoc.querySelector('.social-links');
                if (previewLinks) {
                    previewLinks.innerHTML = window.state.socialLinks.map(link => `
                        <a href="${sanitizeHtml(link.url)}" target="_blank" rel="noopener noreferrer" class="social-link">
                            ${link.icon}
                        </a>
                    `).join('');
                }
            }
        }

        function renderSocialLinks() {
            const container = document.getElementById('socialLinksList');
            if (!container) {
                console.error('Elemento socialLinksList n√£o encontrado');
                return;
            }

            // Atualiza tamb√©m os links no preview
            const previewLinks = document.querySelector('.social-links');
            if (previewLinks) {
                previewLinks.innerHTML = window.state.socialLinks.map(link => `
                    <a href="${sanitizeHtml(link.url)}" target="_blank" rel="noopener noreferrer" class="social-link">
                        ${link.icon}
                    </a>
                `).join('');
            }

            // Verifica se o estado vazio j√° existe, se n√£o, cria
            let emptyState = document.getElementById('socialEmptyState');
            if (!emptyState) {
                emptyState = document.createElement('div');
                emptyState.id = 'socialEmptyState';
                emptyState.className = 'social-empty-state';
                emptyState.innerHTML = `
                    <div class="social-empty-state-icon">üì±</div>
                    <p>Nenhuma rede social adicionada ainda</p>
                `;
                container.appendChild(emptyState);
            }
            
            // Limpa o container antes de renderizar
            container.innerHTML = '';
            
            if (window.state.socialLinks.length === 0) {
                container.appendChild(emptyState);
                return;
            }

            // Renderiza os links sociais
            const linksHTML = window.state.socialLinks.map(link => `
                <div class="social-link-item">
                    <div class="social-icon-preview">
                        ${link.icon}
                    </div>
                    <div class="social-link-info">
                        <div class="social-link-name">${sanitizeHtml(link.name)}</div>
                        <div class="social-link-url">${sanitizeHtml(link.url)}</div>
                    </div>
                    <div class="social-link-actions">
                        <button class="btn-small btn-secondary-small" onclick="editSocialLink(${link.id})">‚úèÔ∏è</button>
                        <button class="btn-small btn-danger-small" onclick="deleteSocialLink(${link.id})">üóëÔ∏è</button>
                    </div>
                </div>
            `).join('');
            
            container.innerHTML = linksHTML;
        }

        // Editar link social
        function editSocialLink(id) {
            const link = socialLinks.find(l => l.id === id);
            if (!link) return;

            document.getElementById('socialName').value = link.name;
            document.getElementById('socialUrl').value = link.url;

            // Se for um √≠cone predefinido
            if (link.icon.includes('fa-')) {
                const network = link.icon.match(/fa-(\w+)/)[1];
                const option = document.querySelector(`[data-network="${network}"]`);
                if (option) {
                    option.click();
                }
            } else {
                // Se for um √≠cone personalizado
                document.querySelector('[data-tab="custom"]').click();
                document.getElementById('customIcon').value = link.icon;
                document.getElementById('customIconPreview').textContent = link.icon;
            }

            openSocialModal();
            
            // Remover o link antigo
            socialLinks = socialLinks.filter(l => l.id !== id);
        }

        // Deletar link social
        function deleteSocialLink(id) {
            if (confirm('Tem certeza que deseja excluir esta rede social?')) {
                window.state.socialLinks = window.state.socialLinks.filter(l => l.id !== id);
                renderSocialLinks();
                if (typeof markAsUnsaved === 'function') markAsUnsaved();
                if (typeof update === 'function') update();
                
                // Atualiza o preview e remove do Firebase
                updatePreviewSocialLinks();

                // Remove do Firebase
                const user = firebase.auth().currentUser;
                if (user && firebase.firestore) {
                    const db = firebase.firestore();
                    const socialLinksRef = db.collection('site').doc('cliente-001').collection('social_links').doc('data');
                    socialLinksRef.set({ 
                        links: window.state.socialLinks 
                    }, { merge: true })
                    .then(() => {
                        toastSystem.show('‚úÖ Rede social removida e salva com sucesso!', 'success');
                    })
                    .catch(error => {
                        console.error('Erro ao salvar no Firebase:', error);
                        toastSystem.show('‚ö†Ô∏è Rede social removida, mas houve erro ao salvar no Firebase', 'warning');
                    });
                }
            }
        }

        // Inicializar lista vazia
        renderSocialLinks();
    </script>

</body>
</html>