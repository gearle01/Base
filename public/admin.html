<!DOCTYPE html>
<html lang="pt-BR" class="admin-panel">

<head>
    <meta charset="UTF-C">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- ‚úÖ MELHORIA: T√≠tulo mais descritivo -->
    <title>Painel de Administra√ß√£o</title>

    <!-- Meta tags de seguran√ßa e PWA -->
    <meta name="robots" content="noindex, nofollow">

    <!-- ‚úÖ MELHORIA: Carrega o CSS cr√≠tico primeiro -->
    <link rel="stylesheet" href="css/critical.css">

    <!-- Leaflet (para o mapa) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css"
        xintegrity="sha512-Zcn6rR11GGFinPdNaPdbaXGEpDNBJp/ZsdXQZ+BYE8QIW6BI8naZfQGIIvtYYzF/r9/eSgcJVEFn6SZiXlTwMA=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />

    <!-- ‚úÖ MELHORIA: Carrega outros CSS de forma ass√≠ncrona -->
    <link rel="stylesheet" href="css/admin.css" media="print" onload="this.media='all'">
    <link rel="stylesheet" href="css/modal.css" media="print" onload="this.media='all'">
    <noscript>
        <link rel="stylesheet" href="css/admin.css">
        <link rel="stylesheet" href="css/modal.css">
    </noscript>

    <!-- Fontes (Preconnect) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
</head>

<body>
    <!-- Header Fixo -->
    <header class="admin-header">
        <h2>Painel de Controle</h2>
        <div class="header-actions">
            <!-- ‚úÖ MELHORIA: 'saveStatus' movido para c√° para melhor visibilidade -->
            <div id="saveStatus" class="save-status saved">
                <span id="saveText">‚úì Salvo</span>
            </div>
            <button id="saveButton" class="btn btn-primary" onclick="saveConfig()">Salvar Altera√ß√µes</button>
            <button class="btn btn-secondary" onclick="logout()">Sair</button>
        </div>
    </header>

    <div class="admin-container">
        <!-- Conte√∫do Principal -->
        <main class="admin-content">
            <div class="content-preview-grid">

                <!-- Coluna de Configura√ß√µes (Esquerda) -->
                <div class="config-column">

                    <!-- Se√ß√£o Geral -->
                    <section id="geral" class="config-section">
                        <h3>Geral</h3>

                        <!-- Nome da Empresa -->
                        <div class="form-group">
                            <label for="empresaNome">Nome da Empresa</label>
                            <input type="text" id="empresaNome" class="form-control"
                                placeholder="Nome que aparece no site" oninput="markAsUnsaved(); update();">
                        </div>

                        <!-- Tipo de Logo -->
                        <div class="form-group">
                            <label>Tipo de Logo</label>
                            <input type="hidden" id="logoType" value="text">
                            <div class="btn-group">
                                <button class="btn btn-secondary" onclick="setLogoType('text')">Texto</button>
                                <button class="btn btn-secondary" onclick="setLogoType('image')">Imagem</button>
                            </div>
                        </div>

                        <!-- Logo Imagem (Oculto por padr√£o) -->
                        <div class="form-group hidden" id="logoImageInputGroup">
                            <label for="logoUpload">Upload do Logo (Recomendado .svg)</label>
                            <div class="image-upload-box">
                                <div class="image-preview" id="logoPreview" style="background-image: url('');"></div>
                                <input type="file" id="logoUpload" class="form-control"
                                    accept="image/png, image/jpeg, image/svg+xml, image/webp"
                                    onchange="handleImageUpload(event, 'logoImageUrl', '#logoPreview')">
                            </div>
                            <input type="text" id="logoImageUrl" class="form-control"
                                placeholder="URL do logo (autom√°tico)" readonly oninput="markAsUnsaved(); update();">
                        </div>

                        <!-- Favicon -->
                        <div class="form-group">
                            <label for="faviconUpload">Favicon (√çcone da Aba)</label>
                            <div class="image-upload-box small">
                                <div class="image-preview" id="faviconPreview" style="background-image: url('');"></div>
                                <input type="file" id="faviconUpload" class="form-control"
                                    accept="image/png, image/ico, image/svg+xml"
                                    onchange="handleImageUpload(event, 'faviconImageUrl', '#faviconPreview')">
                            </div>
                            <input type="text" id="faviconImageUrl" class="form-control"
                                placeholder="URL do favicon (autom√°tico)" readonly oninput="markAsUnsaved(); update();">
                        </div>

                        <!-- Banner -->
                        <div class="form-group">
                            <label for="bannerTitulo">T√≠tulo do Banner</label>
                            <input type="text" id="bannerTitulo" class="form-control" placeholder="T√≠tulo principal"
                                oninput="markAsUnsaved(); update();">
                        </div>
                        <div class="form-group">
                            <label for="bannerSubtitulo">Subt√≠tulo do Banner</label>
                            <input type="text" id="bannerSubtitulo" class="form-control" placeholder="Texto de apoio"
                                oninput="markAsUnsaved(); update();">
                        </div>
                        <div class="form-group">
                            <label for="bannerUpload">Imagem de Fundo do Banner</label>
                            <div class="image-upload-box">
                                <div class="image-preview" id="bannerPreview" style="background-image: url('');"></div>
                                <input type="file" id="bannerUpload" class="form-control"
                                    accept="image/png, image/jpeg, image/webp"
                                    onchange="handleImageUpload(event, 'bannerImagem', '#bannerPreview')">
                            </div>
                            <input type="text" id="bannerImagem" class="form-control"
                                placeholder="URL da imagem (autom√°tico)" readonly oninput="markAsUnsaved(); update();">
                        </div>
                    </section>

                    <!-- Se√ß√£o Cores e Fontes -->
                    <section id="cores" class="config-section">
                        <h3>Cores e Fontes</h3>
                        <div class="form-group">
                            <label for="corPrimaria">Cor Prim√°ria</label>
                            <input type="color" id="corPrimaria" class="form-control color-input" value="#007bff"
                                oninput="markAsUnsaved(); update();">
                        </div>
                        <div class="form-group">
                            <label for="corSecundaria">Cor Secund√°ria (Ex: WhatsApp)</label>
                            <input type="color" id="corSecundaria" class="form-control color-input" value="#28a745"
                                oninput="markAsUnsaved(); update();">
                        </div>
                        <!-- Fontes (Exemplo) -->
                        <div class="form-group">
                            <label for="fontUrl">URL da Fonte (Google Fonts)</label>
                            <input type="text" id="fontUrl" class="form-control"
                                placeholder="Ex: https://fonts.googleapis.com/css2?family=Roboto..."
                                oninput="markAsUnsaved(); update();">
                        </div>
                        <div class="form-group">
                            <label for="fontFamily">Nome da Fonte (CSS)</label>
                            <input type="text" id="fontFamily" class="form-control"
                                placeholder="Ex: 'Roboto', sans-serif" oninput="markAsUnsaved(); update();">
                        </div>
                    </section>

                    <!-- Se√ß√£o Sobre -->
                    <section id="sobre" class="config-section">
                        <h3>Sobre</h3>
                        <div class="form-group">
                            <label for="sobreTexto">Texto</label>
                            <textarea id="sobreTexto" class="form-control" rows="8"
                                oninput="markAsUnsaved(); update();"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="sobreUpload">Imagem da Se√ß√£o Sobre</label>
                            <div class="image-upload-box">
                                <div class="image-preview" id="sobrePreview" style="background-image: url('');"></div>
                                <input type="file" id="sobreUpload" class="form-control"
                                    accept="image/png, image/jpeg, image/webp"
                                    onchange="handleImageUpload(event, 'sobreImagem', '#sobrePreview')">
                            </div>
                            <input type="text" id="sobreImagem" class="form-control"
                                placeholder="URL da imagem (autom√°tico)" readonly oninput="markAsUnsaved(); update();">
                        </div>
                    </section>

                    <!-- Se√ß√£o Produtos -->
                    <section id="produtos" class="config-section">
                        <h3>Produtos/Servi√ßos</h3>
                        <div id="produtosList">
                            <!-- Lista renderizada pelo app.js -->
                        </div>
                        <!-- ‚úÖ MELHORIA: Onclick chama 'openProdutoModal' do app.js -->
                        <button class="btn btn-secondary" onclick="openProdutoModal(-1)">Adicionar Produto</button>
                    </section>

                    <!-- Se√ß√£o Contato -->
                    <section id="contato" class="config-section">
                        <h3>Contato e Mapa</h3>
                        <div class="form-group">
                            <label for="telefone">Telefone (WhatsApp)</label>
                            <input type="tel" id="telefone" class="form-control" oninput="markAsUnsaved(); update();">
                        </div>
                        <div class="form-group">
                            <label for="telefone2">Telefone 2 (Opcional)</label>
                            <input type="tel" id="telefone2" class="form-control" oninput="markAsUnsaved(); update();">
                        </div>
                        <div class="form-group">
                            <label for="email">E-mail</label>
                            <input type="email" id="email" class="form-control" oninput="markAsUnsaved(); update();">
                        </div>
                        <div class="form-group">
                            <label for="endereco">Endere√ßo</label>
                            <input type="text" id="endereco" class="form-control" oninput="markAsUnsaved(); update();">
                        </div>
                        <div class="form-group form-check">
                            <input type="checkbox" id="mostrarMapa" class="form-check-input"
                                onchange="markAsUnsaved(); update();">
                            <label for="mostrarMapa" class="form-check-label">Mostrar Mapa</label>
                        </div>
                        <div class="form-group">
                            <label>Latitude / Longitude</label>
                            <div class="input-group">
                                <input type="number" id="latitude" class="form-control"
                                    oninput="markAsUnsaved(); update();">
                                <input type="number" id="longitude" class="form-control"
                                    oninput="markAsUnsaved(); update();">
                            </div>
                            <small>Use o mapa abaixo para encontrar as coordenadas.</small>
                        </div>
                        <div id="adminMap" style="height: 300px; border-radius: 8px; margin-top: 1rem;"></div>
                    </section>

                    <!-- Se√ß√£o Redes Sociais -->
                    <section id="social" class="config-section">
                        <h3>Redes Sociais</h3>
                        <div id="socialLinksList" class="social-links-admin-list">
                            <!-- Lista de links renderizada pelo app.js -->
                        </div>
                        <div id="socialEmptyState" class="empty-state">
                            <p>Nenhuma rede social adicionada.</p>
                        </div>
                        <!-- ‚úÖ MELHORIA: Onclick chama 'addSocialLink' do app.js -->
                        <button class="btn btn-secondary" onclick="addSocialLink()">Adicionar Rede Social</button>
                    </section>

                    <!-- Se√ß√£o M√≥dulos -->
                    <section id="modulos" class="config-section">
                        <h3>M√≥dulos Vis√≠veis</h3>
                        <div class="module-toggle-list">
                            <div class="module-toggle">
                                <span>Sobre</span>
                                <div class="switch" data-module="sobre"></div>
                            </div>
                            <div class="module-toggle">
                                <span>Produtos</span>
                                <div class="switch" data-module="produtos"></div>
                            </div>
                            <div class="module-toggle">
                                <span>Contato</span>
                                <div class="switch" data-module="contato"></div>
                            </div>
                        </div>
                    </section>

                </div>

                <!-- Coluna de Preview (Direita) -->
                <div class="preview-column">
                    <div class="preview-sticky-container">
                        <iframe id="preview-iframe" src="index.html" title="Preview do Site"></iframe>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- MODAIS -->

    <!-- Modal: Produtos -->
    <div id="produtoModal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeProdutoModal()">&times;</span>
            <h4 id="produtoModalTitle">Adicionar Produto</h4>
            <input type="hidden" id="produtoId">
            <div class="form-group">
                <label for="produtoNome">Nome</label>
                <input type="text" id="produtoNome" class="form-control" required>
            </div>
            <div class="form-group">
                <label for="produtoPreco">Pre√ßo</label>
                <input type="text" id="produtoPreco" class="form-control" required>
            </div>
            <div class="form-group">
                <label for="produtoDescricao">Descri√ß√£o (Opcional)</label>
                <textarea id="produtoDescricao" class="form-control" rows="4"></textarea>
            </div>
            <!-- ‚úÖ MELHORIA: Onclick chama 'saveProduto' do app.js -->
            <button class="btn btn-primary" onclick="saveProduto()">Salvar Produto</button>
        </div>
    </div>

    <!-- Modal: Redes Sociais -->
    <div id="socialLinkModal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeSocialModal()">&times;</span>
            <h4>Configurar Rede Social</h4>
            <input type="hidden" id="currentSocialLinkIndex">
            <div class="form-group">
                <label for="socialLinkName">Nome (Ex: Instagram)</label>
                <input type="text" id="socialLinkName" class="form-control" required>
            </div>
            <div class="form-group">
                <label for="socialLinkUrl">URL (link completo)</label>
                <input type="url" id="socialLinkUrl" class="form-control" placeholder="https://www.instagram.com/..."
                    required>
            </div>
            <!-- ‚úÖ MELHORIA: Onclick chama 'saveSocialLinkChanges' do app.js -->
            <button class="btn btn-primary" onclick="saveSocialLinkChanges()">Salvar Link</button>
        </div>
    </div>

    <!-- Toast Notification Container -->
    <div id="toastContainer"></div>


    <!-- ‚úÖ MELHORIA: Scripts movidos para o final do body -->
    <!-- ‚úÖ MELHORIA: Removido 'firebase-config.local.js' e unificado com 'firebase-config.js' -->

    <!-- Carregadores Modulares (Carregados primeiro) -->
    <script src="js/firebase-loader.js" defer></script>
    <script src="js/leaflet-loader.js" defer></script>
    <script src="js/toast.js" defer></script>
    <script src="js/validation.js" defer></script>
    <script src="js/config-manager.js" defer></script>

    <!-- SDKs do Firebase (Carregados via loader ou diretamente) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>

    <!-- Configura√ß√£o e Managers Principais -->
    <script src="js/firebase-config.js"></script> <!-- Unificado -->
    <script src="js/auth-manager.js"></script>
    <script src="js/firebase-manager.js"></script> <!-- Depende de validation.js -->

    <!-- L√≥gica da Aplica√ß√£o Admin -->
    <script src="js/admin-map.js"></script>
    <script src="js/app.js"></script> <!-- Cont√©m a l√≥gica principal do admin -->


    <!-- ‚úÖ MELHORIA: Bloco de script inline removido -->
    <!-- Todo o c√≥digo de toast, social link e produto foi removido daqui -->
    <!-- e agora √© carregado exclusivamente de 'app.js' e 'toast.js' -->
    <script>
        // Script inline m√≠nimo para inicializa√ß√£o

        // Inicializa o Auth Manager
        let authManager;
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('üî• [admin.html] Inicializando Firebase...');
            try {
                // Garante que o SDK do Firebase foi carregado
                if (typeof firebase === 'undefined') {
                    console.error('Firebase SDK n√£o carregou a tempo.');
                    showToast('Erro cr√≠tico: Falha ao carregar Firebase.', 'error');
                    return;
                }

                if (typeof firebaseConfig === 'undefined') {
                    console.error('firebaseConfig n√£o foi carregado.');
                    showToast('Erro cr√≠tico: Falha ao carregar configura√ß√£o.', 'error');
                    return;
                }

                firebase.initializeApp(firebaseConfig);
                console.log('‚úÖ [admin.html] Firebase inicializado com sucesso.');

                // Inicializa o AuthManager (agora com 'showToast' global)
                if (typeof AuthManager !== 'undefined') {
                    window.authManager = new AuthManager('admin', firebase.auth(), showToast);
                    console.log('üîê [admin.html] Verificando acesso com Auth Manager...');
                    await window.authManager.init();
                } else {
                    console.error('AuthManager n√£o est√° definido.');
                }

            } catch (error) {
                console.error('‚ùå Erro na inicializa√ß√£o do admin.html:', error);
                if (typeof showToast === 'function') {
                    showToast('Erro ao inicializar: ' + error.message, 'error');
                }
            }
        });

        // Inicializa o mapa
        document.addEventListener('DOMContentLoaded', () => {
            if (typeof LeafletLoader !== 'undefined') {
                LeafletLoader.load({
                    mapId: 'adminMap',
                    latId: 'latitude',
                    lngId: 'longitude',
                    isDraggable: true,
                    onInit: (map) => {
                        console.log('üìç Inicializando mapa do admin...');
                        map.on('click', function (e) {
                            const { lat, lng } = e.latlng;
                            document.getElementById('latitude').value = lat.toFixed(6);
                            document.getElementById('longitude').value = lng.toFixed(6);
                            LeafletLoader.updateMarker(lat, lng);
                            markAsUnsaved();
                            update();
                        });
                    }
                }).then(() => {
                    console.log('‚úÖ Mapa carregado com sucesso!');
                }).catch(err => {
                    console.error('‚ùå Erro ao carregar mapa:', err);
                });
            }
        });

        // Listener para os switches de M√≥dulos
        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('.switch').forEach(sw => {
                sw.addEventListener('click', () => {
                    sw.classList.toggle('active');
                    const module = sw.dataset.module;
                    if (window.state && window.state.modules) {
                        window.state.modules[module] = sw.classList.contains('active');
                        markAsUnsaved();
                        update();
                    }
                });
            });
        });
    </script>

</body>

</html>